# For more details on how to configure Wrangler, refer to:
# https://developers.cloudflare.com/workers/wrangler/configuration/

name = "shade-me"
compatibility_date = "2025-12-12"
compatibility_flags = ["nodejs_compat"]
main = "workers/app.ts"

# Custom Domain Configuration
# Configure hwmnbn.me as the custom domain for this Worker
# This single route catches all traffic and routes are handled by React Router
routes = [
  { pattern = "hwmnbn.me/*", zone_name = "hwmnbn.me" }
]

# Application Routes (handled by React Router v7)
# Social Routes:
#   /                    - Home/landing page
#   /login               - User login
#   /register            - User registration
#   /feed                - Social feed
#   /friends             - Friends list
#   /groups              - Groups/communities
#   /messages            - Direct messages
#   /profile/me          - User profile
#   /settings            - Account settings (includes hidden game access)
#
# Game Routes (Shade RPG - accessible via /settings):
#   /shade               - Game landing page
#   /shade/dashboard     - Character dashboard
#   /shade/battle        - Battle system
#   /shade/players       - Find players
#   /shade/battles/:id   - Individual battle view
#   /shade/leaderboard   - Global leaderboard
#
# API Routes (handled by Hono backend):
#   /api/auth/*          - Authentication endpoints
#   /api/users/*         - User management
#   /api/social/*        - Social features (posts, comments, groups)
#   /api/game/*          - Game features (character, battles)

# Observability Configuration
# Enable logging for debugging and monitoring
[observability]
enabled = true
head_sampling_rate = 1

[observability.logs]
enabled = true
head_sampling_rate = 1
persist = true
invocation_logs = true

[observability.traces]
enabled = true
head_sampling_rate = 1
persist = true

# Bindings
# These allow your Worker to interact with Cloudflare resources.
# https://developers.cloudflare.com/workers/runtime-apis/bindings/

# D1 Database Bindings
# https://developers.cloudflare.com/d1/get-started/
[[d1_databases]]
binding = "DB"
database_name = "social_rpg_db"
database_id = "fa8ff2b3-6fc2-4ae7-bcd9-eaf5bb2ef6e6"
migrations_dir = "migrations"

# Durable Object Bindings
# https://developers.cloudflare.com/workers/wrangler/configuration/#durable-objects
[durable_objects]
bindings = [
  { name = "BATTLE_ROOM", class_name = "BattleRoom" },
  { name = "GAME_PRESENCE_ROOM", class_name = "GamePresenceRoom" }
]

# KV Namespace Bindings
# https://developers.cloudflare.com/kv/
[[kv_namespaces]]
binding = "APP_CONFIG"
id = "fe2dc674037f49cc84498977f55f5d39"

# R2 Storage Bucket
# https://developers.cloudflare.com/r2/
[[r2_buckets]]
binding = "MEDIA"
bucket_name = "shade-media"

# Workers AI Binding
# https://developers.cloudflare.com/workers-ai/
[ai]
binding = "AI"
# Queue Producer Bindings
# https://developers.cloudflare.com/queues/
[[queues.producers]]
queue = "background-jobs"
binding = "JOBS_QUEUE"

#Configure your Worker to consume messages from this queue:

[[queues.consumers]]
queue = "background-jobs"
max_batch_size = 10

# Cron Triggers
# https://developers.cloudflare.com/workers/wrangler/configuration/#cron-triggers
[triggers]
crons = ["*/15 * * * *"] # Every 15 minutes for offline XP accrual

# Environment Variables & Secrets
# https://developers.cloudflare.com/workers/wrangler/configuration/#environment-variables
[vars]
# Google OAuth - Client ID is public, set via env or secret for the actual value
# GOOGLE_CLIENT_ID should be set as a secret via: wrangler secret put GOOGLE_CLIENT_ID
APP_URL = "https://hwmnbn.me"
# Game Configuration
XP_RATE_PER_HOUR = 10
DAILY_XP_CAP = 240 # 24 hours * 10 XP/hour
WIN_XP_AWARD = 50
MITIGATION_FACTOR = 0.7
# Using JSON string for class modifiers to be easily parsable
CLASS_MODS = """
{
  "phoenix": { "attack": 1.1, "defense": 0.95 },
  "dphoenix": { "attack": 1.1, "defense": 0.95 },
  "dragon": { "attack": 0.95, "defense": 1.1 },
  "ddragon": { "attack": 0.95, "defense": 1.1 },
  "kies": { "attack": 1.0, "defense": 1.0 }
}
"""

[placement]
mode = "smart"

# The `new_classes` field is required by wrangler for the first migration that introduces Durable Objects.
[[migrations]]
tag = "v1"
new_classes = ["BattleRoom", "GamePresenceRoom"]
