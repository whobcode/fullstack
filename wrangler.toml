# For more details on how to configure Wrangler, refer to:
# https://developers.cloudflare.com/workers/wrangler/configuration/

name = "social-rpg-platform"
compatibility_date = "2024-04-05"
main = "workers/app.ts"

# Custom Domain Configuration
# Configure hwmnbn.me as the custom domain for this Worker
routes = [
  { pattern = "hwmnbn.me/*", zone_name = "hwmnbn.me" }
]

# Observability Configuration
# Enable logging and tracing for debugging and monitoring
[observability]
enabled = false
head_sampling_rate = 1

[observability.logs]
enabled = true
head_sampling_rate = 1
persist = true
invocation_logs = true

[observability.traces]
enabled = true
persist = true
head_sampling_rate = 1

# Bindings
# These allow your Worker to interact with Cloudflare resources.
# https://developers.cloudflare.com/workers/runtime-apis/bindings/

# D1 Database Bindings
# https://developers.cloudflare.com/d1/get-started/
[[d1_databases]]
binding = "DB"
database_name = "social_rpg_db"
database_id = "fa8ff2b3-6fc2-4ae7-bcd9-eaf5bb2ef6e6"
migrations_dir = "migrations"

# Durable Object Bindings
# https://developers.cloudflare.com/workers/wrangler/configuration/#durable-objects
[durable_objects]
bindings = [
  { name = "BATTLE_ROOM", class_name = "BattleRoom" },
  { name = "GAME_PRESENCE_ROOM", class_name = "GamePresenceRoom" }
]

# KV Namespace Bindings
# https://developers.cloudflare.com/kv/
[[kv_namespaces]]
binding = "APP_CONFIG"
id = "fe2dc674037f49cc84498977f55f5d39"
# Queue Producer Bindings
# https://developers.cloudflare.com/queues/
[[queues.producers]]
queue = "background-jobs"
binding = "JOBS_QUEUE"

#Configure your Worker to consume messages from this queue:

[[queues.consumers]]
queue = "background-jobs"
max_batch_size = 10

# Cron Triggers
# https://developers.cloudflare.com/workers/wrangler/configuration/#cron-triggers
[triggers]
crons = ["*/15 * * * *"] # Every 15 minutes for offline XP accrual

# Environment Variables & Secrets
# https://developers.cloudflare.com/workers/wrangler/configuration/#environment-variables
# Note: VITE_FACEBOOK_APP_ID is configured as a secret via Cloudflare Dashboard or wrangler CLI
[vars]
# Facebook OAuth
VITE_FACEBOOK_AUTH_ENDPOINT = "/auth/facebook"
VITE_FACEBOOK_APP_ID = "1165354375707892"
# Game Configuration
XP_RATE_PER_HOUR = 10
DAILY_XP_CAP = 240 # 24 hours * 10 XP/hour
WIN_XP_AWARD = 50
MITIGATION_FACTOR = 0.8
# Using JSON string for class modifiers to be easily parsable
CLASS_MODS = """
{
  "phoenix": { "attack": 1.1, "defense": 0.95 },
  "dphoenix": { "attack": 1.1, "defense": 0.95 },
  "dragon": { "attack": 0.95, "defense": 1.1 },
  "ddragon": { "attack": 0.95, "defense": 1.1 },
  "kies": { "attack": 1.0, "defense": 1.0 }
}
"""

[placement]
mode = "smart"

# The `new_classes` field is required by wrangler for the first migration that introduces Durable Objects.
[[migrations]]
tag = "v1"
new_classes = ["BattleRoom", "GamePresenceRoom"]
